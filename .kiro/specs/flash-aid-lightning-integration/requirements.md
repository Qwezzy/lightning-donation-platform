# Requirements Document

## Introduction

Flash Aid is a Lightning Network-based disaster relief donation platform that enables instant, zero-fee donations from donors to recipients through a hub node operated by an NGO. The system leverages Bitcoin's Lightning Network to provide cryptographic proof of payment delivery while supporting micropayments in disaster zones where traditional banking infrastructure has failed.

## Glossary

- **Lightning_Network**: A Layer 2 payment protocol built on Bitcoin that enables instant, low-cost transactions through payment channels
- **LND**: Lightning Network Daemon, the implementation used for Lightning node operations
- **Payment_Channel**: A bidirectional payment channel between two Lightning nodes that enables off-chain transactions
- **Invoice**: A payment request generated by a recipient containing payment hash, amount, and destination information
- **Preimage**: The cryptographic proof that a payment was successfully delivered (the secret that unlocks the payment hash)
- **Payment_Hash**: A cryptographic hash of the preimage used to lock funds during routing
- **Donor_Node**: Alice, the Lightning node sending donations
- **Hub_Node**: Bob, the well-connected NGO node that routes payments with zero fees
- **Recipient_Node**: Charlie, the merchant or camp coordinator receiving donations
- **Satoshi**: The smallest unit of Bitcoin (0.00000001 BTC)
- **Regtest**: Bitcoin's regression test mode for local development
- **HTLC**: Hash Time-Locked Contract, the mechanism that enables trustless routing
- **Channel_Capacity**: The total amount of Bitcoin locked in a payment channel
- **Channel_Balance**: The distribution of funds between the two parties in a channel
- **Macaroon**: Authentication token for LND API access
- **TLS_Certificate**: Transport Layer Security certificate for encrypted LND communication
- **Frontend**: The web-based user interface for donors and recipients
- **Backend**: The Express.js server that handles API requests and Lightning operations
- **QR_Code**: A visual representation of the Lightning invoice for mobile wallet scanning

## Requirements

### Requirement 1: Lightning Node Connectivity

**User Story:** As a system operator, I want to establish and maintain connections between Lightning nodes, so that payment channels can be created and payments can be routed.

#### Acceptance Criteria

1. WHEN the system starts, THE Lightning_Client SHALL connect to LND using valid TLS_Certificate and Macaroon credentials
2. WHEN connecting to LND, THE Lightning_Client SHALL verify the node identity and connection status
3. IF connection to LND fails, THEN THE Lightning_Client SHALL return a descriptive error message
4. THE Lightning_Client SHALL maintain persistent connections to LND throughout the application lifecycle
5. WHEN querying node information, THE Lightning_Client SHALL return the node's public key, alias, and network status

### Requirement 2: Payment Channel Management

**User Story:** As a system operator, I want to manage payment channels between nodes, so that funds can flow through the network with appropriate capacity.

#### Acceptance Criteria

1. WHEN querying channels, THE Channel_Manager SHALL return all active channels with their capacity, local balance, and remote balance
2. WHEN opening a channel, THE Channel_Manager SHALL create a channel with specified capacity between two nodes
3. WHEN a channel is opened, THE Channel_Manager SHALL wait for the channel to become active before confirming success
4. WHEN closing a channel, THE Channel_Manager SHALL initiate cooperative closure and return the closing transaction ID
5. THE Channel_Manager SHALL verify that Hub_Node channels have zero routing fees configured
6. WHEN channel capacity is insufficient for a payment, THE Channel_Manager SHALL return an error indicating insufficient funds

### Requirement 3: Invoice Generation and Management

**User Story:** As a recipient, I want to generate payment invoices for specific amounts and purposes, so that donors can send me funds for disaster relief supplies.

#### Acceptance Criteria

1. WHEN a recipient requests an invoice, THE Invoice_Generator SHALL create a Lightning invoice with the specified amount in satoshis
2. WHEN creating an invoice, THE Invoice_Generator SHALL include a human-readable description of the payment purpose
3. WHEN an invoice is created, THE Invoice_Generator SHALL return the payment request string, payment hash, and expiration time
4. THE Invoice_Generator SHALL set invoice expiration to a reasonable timeframe (minimum 1 hour)
5. WHEN an invoice expires before payment, THE Invoice_Generator SHALL mark it as expired and prevent payment
6. WHEN an invoice is paid, THE Invoice_Generator SHALL detect the payment and return the preimage as proof

### Requirement 4: Payment Routing and Execution

**User Story:** As a donor, I want to send payments through the Lightning Network to recipients, so that my donations arrive instantly with zero fees.

#### Acceptance Criteria

1. WHEN a donor initiates a payment, THE Payment_Router SHALL decode the invoice to extract payment details
2. WHEN routing a payment, THE Payment_Router SHALL find a valid path from Donor_Node through Hub_Node to Recipient_Node
3. WHEN executing a payment, THE Payment_Router SHALL send the payment using HTLCs to ensure atomicity
4. WHEN a payment succeeds, THE Payment_Router SHALL return the preimage as cryptographic proof of delivery
5. IF no route exists, THEN THE Payment_Router SHALL return an error indicating route failure
6. IF payment fails during routing, THEN THE Payment_Router SHALL return the failure reason and ensure no funds are lost
7. THE Payment_Router SHALL verify that payments through Hub_Node incur zero routing fees

### Requirement 5: Cryptographic Proof of Payment

**User Story:** As a donor, I want to receive cryptographic proof that my donation reached the recipient, so that I have verifiable evidence of successful delivery.

#### Acceptance Criteria

1. WHEN a payment completes successfully, THE Proof_Manager SHALL store the preimage associated with the payment hash
2. WHEN a donor requests proof, THE Proof_Manager SHALL return the preimage that corresponds to their payment
3. THE Proof_Manager SHALL verify that the preimage correctly hashes to the payment hash from the invoice
4. WHEN storing proof, THE Proof_Manager SHALL associate it with donor information, recipient information, amount, and timestamp
5. THE Proof_Manager SHALL persist proof records to ensure they survive system restarts

### Requirement 6: Donation Tracking and History

**User Story:** As a system administrator, I want to track all donations flowing through the platform, so that I can provide transparency and reporting for the relief effort.

#### Acceptance Criteria

1. WHEN a payment is initiated, THE Donation_Tracker SHALL create a donation record with status "pending"
2. WHEN a payment completes, THE Donation_Tracker SHALL update the donation status to "completed" and store the preimage
3. WHEN a payment fails, THE Donation_Tracker SHALL update the donation status to "failed" and store the failure reason
4. THE Donation_Tracker SHALL store donor identifier, recipient identifier, amount, timestamp, and payment hash for each donation
5. WHEN querying donation history, THE Donation_Tracker SHALL return donations filtered by status, date range, or participant
6. THE Donation_Tracker SHALL persist donation records to disk to ensure data survives system restarts
7. WHEN the system restarts, THE Donation_Tracker SHALL load existing donation records from persistent storage

### Requirement 7: Backend API for Lightning Operations

**User Story:** As a frontend developer, I want a REST API to interact with Lightning Network functionality, so that I can build user interfaces for donors and recipients.

#### Acceptance Criteria

1. THE API SHALL provide an endpoint to generate invoices with amount and description parameters
2. THE API SHALL provide an endpoint to send payments given an invoice payment request string
3. THE API SHALL provide an endpoint to query donation history with optional filtering
4. THE API SHALL provide an endpoint to retrieve payment proof given a payment hash
5. THE API SHALL provide an endpoint to query node information and channel status
6. WHEN an API request succeeds, THE API SHALL return JSON responses with appropriate HTTP status codes
7. WHEN an API request fails, THE API SHALL return error messages with appropriate HTTP status codes and descriptive error details
8. THE API SHALL validate all input parameters before processing requests
9. IF input validation fails, THEN THE API SHALL return a 400 Bad Request error with validation details

### Requirement 8: Frontend Donation Interface

**User Story:** As a donor, I want a web interface to enter donation amounts and complete payments, so that I can easily contribute to disaster relief efforts.

#### Acceptance Criteria

1. WHEN a donor visits the platform, THE Frontend SHALL display a donation form with amount input and description field
2. WHEN a donor enters an amount and clicks donate, THE Frontend SHALL request an invoice from the Backend
3. WHEN an invoice is received, THE Frontend SHALL display the payment request string and generate a QR_Code
4. THE Frontend SHALL display the invoice amount in satoshis and provide visual feedback during invoice generation
5. WHEN displaying the QR_Code, THE Frontend SHALL render it on a canvas element for mobile wallet scanning
6. THE Frontend SHALL poll the Backend to check invoice payment status at regular intervals
7. WHEN payment is detected, THE Frontend SHALL display the preimage as proof of delivery
8. WHEN payment fails or times out, THE Frontend SHALL display an appropriate error message
9. THE Frontend SHALL be mobile-responsive and work on devices of all sizes

### Requirement 9: Real-Time Payment Status Updates

**User Story:** As a donor, I want to see real-time updates on my payment status, so that I know when my donation has been successfully delivered.

#### Acceptance Criteria

1. WHEN an invoice is generated, THE Frontend SHALL begin polling the payment status endpoint
2. THE Frontend SHALL poll at intervals of 2 seconds until payment is detected or timeout occurs
3. WHEN payment status changes to "settled", THE Frontend SHALL stop polling and display success
4. WHEN invoice expires, THE Frontend SHALL stop polling and display expiration message
5. THE Frontend SHALL display loading indicators during status checks
6. THE Backend SHALL provide an endpoint that returns current invoice status including settled state and preimage

### Requirement 10: Error Handling and Recovery

**User Story:** As a system operator, I want robust error handling throughout the platform, so that failures are gracefully managed and the system remains stable.

#### Acceptance Criteria

1. WHEN LND connection fails, THE System SHALL retry connection with exponential backoff
2. WHEN a payment times out, THE System SHALL return funds to the sender and update donation status
3. WHEN channel capacity is exhausted, THE System SHALL return a clear error message indicating insufficient capacity
4. WHEN invalid input is provided, THE System SHALL validate and reject with descriptive error messages
5. WHEN an unexpected error occurs, THE System SHALL log the error details and return a generic error to the user
6. THE System SHALL ensure no funds are lost during any error condition
7. WHEN the system crashes, THE System SHALL recover donation state from persistent storage on restart

### Requirement 11: Zero-Fee Routing Configuration

**User Story:** As an NGO operator, I want to ensure all payments routed through the hub node have zero fees, so that 100% of donations reach recipients.

#### Acceptance Criteria

1. THE Hub_Node SHALL configure all channels with zero base fee and zero fee rate
2. WHEN routing a payment, THE Payment_Router SHALL verify the total fee is zero
3. IF a non-zero fee is detected, THEN THE System SHALL reject the payment and return an error
4. THE System SHALL provide configuration validation to ensure fee settings are correct on startup
5. WHEN querying channel policies, THE System SHALL display fee configuration for verification

### Requirement 12: Micropayment Support

**User Story:** As a donor, I want to send donations as small as 1 satoshi, so that I can contribute even small amounts without fees consuming the principal.

#### Acceptance Criteria

1. THE System SHALL accept invoice amounts as low as 1 satoshi
2. WHEN processing micropayments, THE System SHALL ensure zero fees are applied
3. THE System SHALL validate that channel capacity supports the micropayment amount
4. WHEN displaying amounts, THE Frontend SHALL show amounts in satoshis
5. THE Invoice_Generator SHALL support creating invoices for amounts between 1 satoshi and channel capacity limits

### Requirement 13: Data Persistence and Recovery

**User Story:** As a system administrator, I want donation data to persist across system restarts, so that no donation records are lost.

#### Acceptance Criteria

1. THE Donation_Tracker SHALL store all donation records in a JSON file on disk
2. WHEN a donation record is created or updated, THE Donation_Tracker SHALL immediately write to disk
3. WHEN the system starts, THE Donation_Tracker SHALL load all existing donation records from disk
4. THE System SHALL use atomic file writes to prevent data corruption during writes
5. IF the data file is corrupted, THEN THE System SHALL log an error and start with an empty donation history
6. THE System SHALL create the data directory if it does not exist on startup
